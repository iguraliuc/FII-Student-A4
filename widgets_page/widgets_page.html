<!DOCTYPE html>

<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Widgets Page</title>

  <link rel="stylesheet" href="css/gridstack.css" />
  <link rel="stylesheet" href="css/bootstrap.css" />


  <script src="js/jquery-3.4.1.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/lodash.js"></script>
  <script src="js/shim.js"></script>
  <script src="js/knockout.js"></script>
  <script src="js/knockout.mapping-latest.js"></script>

  <script src="js/bootstrap.js"></script>
  <script src="js/bootstrap-select.js"></script>
  <script src="js/gridstack.all.js"></script>





</head>

<body>
  <div class="widgets-container">

    <div class="menu-container">

      <div style="display: flex; padding: 0px 10px;">
        <form action="" method="POST" enctype="application/x-www-form-urlencoded" style="padding: 0px 10px;">
          <button class="btn" type="submit" data-bind="click: saveChanges">Save settings</button>
        </form>
        <button class="btn" data-bind="click: addNewWidget" style="padding: 0px 10px;">Add new widget</button>

      </div>

      <div class="select-container" data-bind="if: true">
        <select class="form-control" data-bind="optionsCaption: ' ', options: availableTypes, value: selectedType"
          size="1"></select>
      </div>

      <div class="select-container" data-bind="if: hasSecond">
        <select class="form-control" data-bind="optionsCaption: ' ', options: availableSubTypes, value: selectedSubType"
          size="1"></select>
      </div>

    </div>

    <br>

    <div data-bind="component: {name: 'widgets-grid', params: $data}"></div>

  </div>

  <!-- WIDGET TEMPLATE -->
  <template id="widgets-grid-template">
    <div class="grid-stack" data-bind="foreach: {data: widgets, afterRender: afterAddWidget}">
      <div class="grid-stack-item"
        data-bind="attr: {'data-gs-id': $data.id, 'data-gs-x': $data.x, 'data-gs-y': $data.y, 'data-gs-width': $data.width, 'data-gs-height': $data.height, 'data-gs-min-width': $data.minWidth, 'data-gs-min-height': $data.minHeight, 'data-gs-auto-position': $data.autoPosition}">
        <div class="grid-stack-item-content">
          <div class="drag-handle">
            <div data-bind="text: $data.type.toUpperCase()" class="widget-title"></div>
            <button class="close-widget-button" data-bind="click: $root.deleteWidget"><span>x</span></button>
          </div>
          <div class="widget-container"
            data-bind="style: {'overflow-x': $data.specialStyle, 'overflow-y': $data.specialStyle}">
            <div style="height:95%; width: 95%;" class="widget-content"
              data-bind="template: { name: $data.type, data: {subtype: $data.subtype, specific: $data.specific} }">
            </div>
          </div>

        </div>
      </div></div>
    <!-- FARA SPATIU INTRE ULTIMELE DOUA TAGURI </div> 
           ALTFEL NU SE VOR STERGE WIDGETURILE -->
  </template>


  <script type="text/javascript">
    // https://cors-anywhere.herokuapp.com/

    var newsURL = "http://fiistudent.ddns.us/api/news/";
    var resourcesURL = "http://fiistudent.ddns.us/api/resources/";

    var newsAwait = null;
    var resourcesAwait = null;

    var hasWeatherAlready = false;
    var currentDeleted = [];

    ko.components.register('widgets-grid', {
      viewModel: {
        createViewModel: function (controller, componentInfo) {

          var ViewModel = function (controller, componentInfo) {

            var grid = $(componentInfo.element).find('.grid-stack').gridstack({
              auto: false,
              draggable: {
                handle: '.drag-handle',
              }
            }).data('gridstack');

            this.widgets = controller.widgets;

            this.afterAddWidget = function (items) {

              if (grid === null) {
                grid = $(componentInfo.element).find('.grid-stack').gridstack({
                  auto: false,
                  draggable: {
                    handle: '.drag-handle',
                  }
                }).data('gridstack');
              }

              var item = items.find(function (i) { return i.nodeType == 1 });
              grid.addWidget(item);

              ko.utils.domNodeDisposal.addDisposeCallback(item, function () {
                grid.removeWidget(item);
              });

            };

          };

          return new ViewModel(controller, componentInfo);
        }

      },
      template: { element: 'widgets-grid-template' }

    });



    $(function () {
      $('.selectpicker').selectpicker();

      var Controller = function (widgets) {
        var self = this;
        this.widgets = ko.observableArray(widgets);

        this.selectedType = ko.observable("");
        this.selectedSubType = ko.observable("");

        this.availableTypes = ["vremea", "calendar", "news", "resources"];

        this.availableSubTypes = ko.computed(function () {
          var returnValue = null;
          var localSelectedType = self.selectedType();
          if (localSelectedType === "news") {
            returnValue = ["uaic", "fii", "orar", "all"];
          } else if (localSelectedType === "resources") {
            returnValue = ["internal", "external", "all"];
          }
          return returnValue;
        }, this);

        this.hasSecond = ko.computed(function () {
          var selectedLocal = self.selectedType();
          if (selectedLocal === "news" || selectedLocal === "resources") {
            return true;
          } else {
            return false;
          }
        });

        this.getMaxId = function () {
          var gridStack = $(".grid-stack").data('gridstack');
          var widgets = gridStack.grid.nodes;

          let max = 0;
          widgets.forEach(widget => {
            let wId = parseInt(widget.id);
            if (wId > max) {
              max = wId;
            }
          });
          return max;
        }

        this.addNewWidget = function () {
          if(!self.selectedType()){
            return false;
          }

          let tempSpecific = [];
          let minHeight = 1;
          let minWidth = 1;
          let specialStyle = "";

          if (self.selectedType() === "vremea") {
            specialStyle = 'hidden';
            self.widgets().forEach(wid => {
              if (wid.type === "vremea") {
                alert(134);
                hasWeatherAlready = true;
              }
            });
            minHeight = 2;
            minWidth = 6;
          } else if (self.selectedType() === "calendar") {
            specialStyle = 'hidden';

            minHeight = 3;
            minWidth = 3;
          } else if (self.selectedType() === "news") {
            specialStyle = 'auto';
            tempSpecific = newsAwait;
            minHeight = 4;
            minWidth = 6;
            if (self.selectedSubType() === 'uaic') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === 'UAIC';
              });
            } else if (self.selectedSubType() === 'fii') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === 'FII';
              });
            } else if (self.selectedSubType() === 'orar') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === 'ORAR';
              });
            } else if (!self.selectedSubType()){
              return false;
            }
          } else if (self.selectedType() === "resources") {
            specialStyle = 'auto';
            minHeight = 2;
            minWidth = 4;
            tempSpecific = resourcesAwait;
            if (self.selectedSubType() === 'internal') {
              minHeight = 2;
              minWidth = 2;
              tempSpecific = tempSpecific.filter(function (element) {
                return element.url === null;
              });
            } else if (self.selectedSubType() === 'external') {
              minHeight = 2;
              minWidth = 4;
              tempSpecific = tempSpecific.filter(function (element) {
                return element.url !== null;
              });
            } else if (!self.selectedSubType()){
              return false;
            }
          }


          // Aici se adauga widgets noi
         if(!hasWeatherAlready){ 
            this.widgets.push({
            id: this.getMaxId().toString() + "new_created",
            width: minWidth,
            height: minHeight,
            autoPosition: true,
            minWidth: minWidth,
            minHeight: minHeight,
            type: self.selectedType(),
            subtype: self.selectedSubType(),
            specific: tempSpecific,
            specialStyle: specialStyle
          });
        }

          selectedType = null;
          selectedSubType = null;
          return false;
        };

        this.deleteWidget = function (item) {
          if (item.type === "vremea") {
            hasWeatherAlready = false;
          }
          
          if(item.id.toString().search("new_created") === -1){
            currentDeleted.push(item.id);
          }

          self.widgets.remove(item);
          return false;
        };

        this.getTypeOfId = function (id) {
          let searchedWidget = widgets.find(function (element) {
            return element.id === id;
          });
          let typeString = searchedWidget.type + "-" + searchedWidget.subtype;
          return typeString;
        }


        // Functia asta face submit catre server pentru a salva dimensiunile si pozitiile
        this.saveChanges = function () {
          var gridStack = $(".grid-stack").data('gridstack');
          var widgets = gridStack.grid.nodes;

          // let savedWidgets = [];
          // widgets.forEach(widget => {
          //   savedWidgets.push({
          //     id: widget.id,
          //     x: widget.x,
          //     y: widget.y,
          //     width: widget.width,
          //     height: widget.height,
          //     type: this.getTypeOfId(parseInt(widget.id))
          //   });
          // });
          // console.log(savedWidgets);

          currentDeleted.forEach(function (elemId) {
              $.ajax({
              url: '/personalise/cards/remove_card/' + elemId,
              type: 'POST',
              data: {
                'csrfmiddlewaretoken': "{{ csrf_token }}",
              },
              success: function (data, response) {

              }
            });
          })

          widgets.forEach(function (widget) {

            if (widget.id.search("new_created") === -1) {
              $.ajax({
                url: '/personalise/cards/update_card/' + widget.id,
                type: 'POST',
                data: {
                  'csrfmiddlewaretoken': "{{ csrf_token }}",
                  'x': widget.x,
                  'y': widget.y,
                  'width': widget.width,
                  'height': widget.height
                },
                success: function (data, response) {

                }
              });
            } else {

              $.ajax({
                url: '/personalise/cards/add_card',
                type: 'POST',
                data: {
                  'csrfmiddlewaretoken': "{{ csrf_token }}",
                  'x': widget.x,
                  'y': widget.y,
                  'width': widget.width,
                  'height': widget.height,
                  'type': this.getTypeOfId(parseInt(widget.id))
                },
                success: function (data, response) {
                  widget.id = data.id;

                }
              });
            }
          });

          currentDeleted = [];
        } // END saveChanges FUNCTION


        /*  Widgets properties
   
         autoPosition: false
         height: 1
         id: "1"
         maxHeight: undefined
         maxWidth: undefined
         minHeight: undefined
         minWidth: undefined
         noMove: false
         noResize: false
         width: 2
         x: 2
         y: 0
   
       */
      };




      function processServerWidgets(widgetsParam) {
        this.processedWidgets = [];
        widgetsParam.forEach(wid => {
          let typeArr = wid.type.split("-");
          let tempSpecific = [];
          let minHeight = 1;
          let minWidth = 1;
          let specialStyle = "";

          if (typeArr[0] === "vremea") {
            specialStyle = "hidden";
            hasWeatherAlready = true;
            minHeight = 2;
            minWidth = 6;
          } else if (typeArr[0] === "calendar") {
            specialStyle = "hidden";
            minHeight = 3;
            minWidth = 3;
          }
          else if (typeArr[0] === "news") {
            specialStyle = "auto";
            minHeight = 4;
            minWidth = 6;
            tempSpecific = newsAwait;
            if (typeArr[1] === 'uaic') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === "UAIC";
              });
            } else if (typeArr[1] === 'fii') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === "FII";
              });
            } else if (typeArr[1] === 'orar') {
              tempSpecific = tempSpecific.filter(function (element) {
                return element.source === "ORAR";
              });
            }

          } else if (typeArr[0] === "resources") {
            specialStyle = "auto";
            minHeight = 2;
            minWidth = 4;
            tempSpecific = resourcesAwait;
            if (typeArr[1] === 'internal') {
              minHeight = 2;
              minWidth = 2;
              tempSpecific = tempSpecific.filter(function (element) {
                return element.url === null;
              });
            } else if (typeArr[1] === 'external') {
              minHeight = 2;
              minWidth = 4;
              tempSpecific = tempSpecific.filter(function (element) {
                return element.url !== null;
              });
            }
          }

          this.processedWidgets.push({
            id: wid.id,
            x: wid.x,
            y: wid.y,
            width: wid.width,
            height: wid.height,
            type: typeArr[0],
            subtype: typeArr[1],
            specific: tempSpecific,
            minHeight: minHeight,
            minWidth: minWidth,
            specialStyle: specialStyle,
            autoPosition: true
          });
        });
        return this.processedWidgets;
      }


      // primesc widgets de aici, widgets luate de la SERVER
      var widgetsFromServer = [
        {
          id: 0, x: 0, y: 0, width: 6, height: 2,
          type: "vremea"
        },
        {
          id: 1, x: 6, y: 0, width: 6, height: 4,
          type: "calendar"
        },
        {
          id: 2, x: 0, y: 3, width: 6, height: 7,
          type: "news-fii"
        },
        {
          id: 3, x: 6, y: 5, width: 6, height: 5,
          type: "resources-all"
        }
      ];


      // weather widget
      !function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (!d.getElementById(id)) {
          js = d.createElement(s);
          js.id = id;
          js.src = 'https://weatherwidget.io/js/widget.min.js';
          fjs.parentNode.insertBefore(js, fjs);
        }
      }(document, 'script', 'weatherwidget-io-js');


      async function getServerData() {

        newsAwait = await fetch(newsURL)
          .then(function (response) {
            return response.json();
          }).then(function (processed) {
            processed.forEach(element => {
              element.subtype = element.source;
            });
            return processed;
          });
        resourcesAwait = await fetch(resourcesURL)
          .then(function (response) {
            return response.json();
          }).then(function (processed) {
            processed.forEach(element => {
              if (element.url) {
                element.subtype = "external"
                element.redirectLink = element.url;
              } else {
                element.subtype = "internal"
                element.redirectLink = 'http://fiistudent.ddns.us/resources/' + element.resources_id;
              }
            });
            return processed;
          });


        // ko.mapping.fromJS(newsAwait, {}, controller.news);
        // ko.mapping.fromJS(resourcesAwait, {}, controller.resources);
        // console.log(newsAwait);
        console.log(resourcesAwait);
        console.log(newsAwait);



        var widgets = processServerWidgets(widgetsFromServer);

        // widgets ca parametru aici si se transmite la Controller
        var controller = new Controller(widgets);
        ko.applyBindings(controller);
      }

      getServerData();






      // ko.mapping.fromJS(controller.selectedType, {}, controller.activateSubType);

      // var globalWidgetsData = document.querySelectorAll(".grid-stack-item");
      // console.log(globalWidgetsData);
    });


  </script>



  <!-- NEWS TEMPLATE -->
  <script type="text/html" id="news">
    <link rel="stylesheet" href="./css/news-template.css">

    <div style="overflow-x: auto; overflow-y: auto; background-color: var(--background-first); display: flex;">
        <div class="board" data-bind="foreach: {data: $data.specific}">
        
            <div class="anunt-container uaic" style="display: flex; justify-content: center;">
                <!-- <div class="date">
                    <p>April 15, 2019, 10:59 a.m.</p>
                    <p class="day"> Mie.</p>
                </div> -->
                <div class="anunt" style="display: flex; flex-direction: column; align-items: center;">
                    <p class="top" data-bind="text: $data.title"></p>

                    <div class="continut" data-bind="html: $data.body">
                    </div>

                    <a data-bind="attr: {href: 'http://fiistudent.ddns.us/news/'+$data.news_id}">Deschide articolul complet!</a>
                </div>
            </div>

        </div>
    </div>

  </script>

  <!-- RESOURCES TEMPLATE -->
  <script type="text/html" id="resources">
    <link rel="stylesheet" href="./css/resources-template.css">
    <div>
    <div class="resources-container">
    <ul data-bind="foreach: {data: $data.specific}" class="resources-list">
      <li class="resources-item" data-bind="visible: $data.subtype">
        <a class="list-item-text"
          data-bind="text: $data.title, attr:{href: $data.redirectLink}"></a>
      </li>

    </ul>
  </div>
  </div>

  </script>

  <!-- VREMEA TEMPLATE -->
  <script type="text/html" id="vremea">
    <a class="weatherwidget-io" href="https://forecast7.com/ro/47d1627d60/iasi/" data-label_1="IAȘI" data-label_2="Vremea" data-font="Arimo" data-icons="Climacons Animated" data-theme="pure" >IAȘI Vremea</a>
  </script>

  <!-- CALENDAR TEMPLATE -->
  <script type="text/html" id="calendar">

    <iframe src="https://calendar.google.com/calendar/embed?height=600&amp;wkst=2&amp;bgcolor=%23ffffff&amp;ctz=Europe%2FBucharest&amp;src=anI2NWM2dmM2OWplbDZxcTNodmU1ZWVkb2dAZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ&amp;color=%23F6BF26&amp;showTitle=0&amp;showNav=1&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0" 
    style="position: relative; width: 100%; height: 100%;" frameborder="0" scrolling="no" allowfullscreen="">
    </iframe>
  </script>

</body>

</html>